[Korea Finance RAG 작업 요약]
최종 업데이트: 2026-02-18
작성위치: /home/aidome/workspace/korea-finance-rag/PROJECT_REPORT_2026-02-14.txt

0) 현재 확보한 데이터
- Yahoo raw: 7,892건 (`data/raw/yahoo_*.json`)
- DART raw: 3,946건 (`data/raw/dart_*.json`)
- News raw: 1건 (`data/raw/news_*.json`)
- 검색 인덱스 청크: 11,840행 (`data/index/chunks.jsonl`)

1) 스키마
- 문서: `workspace/korea-finance-rag/DATA_SCHEMA_SPEC.md`
- 목적: raw/processed/index 데이터 형식과 필수 필드를 고정해 수집-정규화-인덱싱 간 호환성 유지

2) API 계약서
- 문서: `workspace/korea-finance-rag/API_CONTRACT_SPEC.md`
- 목적: 프론트/백엔드/운영이 동일한 API 요청/응답 규격을 사용하도록 표준화

3) 수집 파이프라인 표준화
- 표준 문서: `workspace/korea-finance-rag/PIPELINE_STANDARD_SPEC.md`
- 정규화 스크립트: `workspace/korea-finance-rag/scripts/normalize_manifest.py`
- 실행 절차 반영: `workspace/korea-finance-rag/README.md:61`
- 효과: 수집 소스별(raw) 데이터를 공통 매니페스트로 정리해 인덱싱 입력 일관성 확보

4) 인덱싱 전략 확정
- 전체 재생성: `scripts/run_index_full.sh`
- 증분 업데이트: `scripts/run_index_incremental.sh`
- 증분 엔진: `scripts/build_index_incremental.py`
- 상태 동기화: `scripts/sync_index_state.py`
- 효과: 초기/대규모 변경은 전체 재생성, 일상 운영은 변경분만 반영하는 구조 확정

5) 검색 품질 기본선(Eval baseline)
- 평가 스크립트: `scripts/eval_search_baseline.py`
- 케이스 파일: `eval/baseline_questions_v1.jsonl`
- 효과: 검색 품질을 주관적 체감이 아닌 재현 가능한 기준으로 측정 가능

6) 운영 최소 요건
- 문서: `workspace/korea-finance-rag/OPS_MINIMUM_SPEC.md`
- 헬스체크: `GET /api/health` (인덱스 버전/문서수 확인)
- 효과: 운영 상태를 빠르게 점검하고 장애 징후를 조기 발견 가능

7) 웹 데이터 관리
- 목적: 터미널 중심 데이터 관리 작업을 웹 UI에서 실행/관리 가능하게 전환
- 기대 효과: 운영자 접근성 향상, 반복 작업 실수 감소

8) 웹 관리자 데이터 관리
- 목적: 관리자 권한 기반으로 데이터 작업을 제어하는 운영 콘솔 정리
- 관련 화면: `/admin`, `/login`
- 효과: 운영 기능 접근 통제 및 관리 절차 단순화

9) 뉴스 수집기
- 추가 스크립트: `workspace/korea-finance-rag/scripts/fetch_news.py`
- 동작: 기업명 기반 RSS 수집 후 `data/raw/news_*.json` 저장
- 자동화 연결:
  - `scripts/run_full_collection.sh`에 뉴스 수집 단계 포함
  - 수집 완료 후 `scripts/build_index_incremental.py` 자동 실행
- 옵션:
  - `NEWS_ENABLED=0` (뉴스 단계 비활성화)
  - `INDEX_ENABLED=0` (증분 인덱싱 단계 비활성화)
  - `INDEX_ALLOW_BOOTSTRAP=1` (초기 상태에서 증분 인덱싱 허용)
- 효과: 뉴스 데이터가 수집 즉시 검색 인덱스에 반영되도록 파이프라인 일체화 완료

10) 타겟/산업 분석 API 및 평가셋 확장
- 타겟 10문항 API: `POST /api/target-analysis`
- 산업 10문항 API: `POST /api/industry-analysis`
- 산업 13/16/19 평가셋: `eval/industry_13_16_19_v1.jsonl` (18건)
- 타겟 10문항 평가셋: `eval/target_analysis_questions_v1.jsonl` (30건)
- 타겟 평가 스크립트: `scripts/eval_target_analysis.py`

11) DART 주석 테이블 파서 강화 (P1)
- 추가 스크립트: `scripts/parse_dart_notes.py`
- 추출 범위: 고객의존도, 사업부(세그먼트), CAPEX, 부채만기/리파이낸싱 관련 텍스트 단서
- 출력 파일: `data/raw/dart_notes_*.json`
- 자동화 연결: `scripts/run_full_collection.sh`에 DART 주석 파싱 단계 포함 (`DART_NOTES_ENABLED=1`)

12) 외부 데이터 파이프라인 연결 (P2)
- 시장점유율 적재: `scripts/import_market_share_external.py` -> `data/raw/market_share_*.json`
- 특허 적재: `scripts/import_patent_external.py` -> `data/raw/patent_*.json`
- ESG 적재: `scripts/import_esg_external.py` -> `data/raw/esg_*.json`
- 통합 실행: `scripts/run_external_enrichment.sh`
- 자동화 옵션: `EXTERNAL_ENRICH_ENABLED=1 EXTERNAL_DIR=data/external ./scripts/run_full_collection.sh`
- 입력 템플릿/가이드: `data/external/README.md`, `data/external/*.template.csv`

13) 밸류에이션 10문항(21~30) 대응
- API: `POST /api/valuation-analysis`
- 질문 범위: EV/EBITDA, comps, WACC, 시나리오 가치, IRR, 시너지, PER, 환율, LBO, EBITDA 조정
- 생성 스크립트:
  - `scripts/build_valuation_cases.py` -> `data/raw/valuation_case_*.json`
  - `scripts/import_mna_comps_external.py` -> `data/raw/mna_*.json`
- 평가셋/평가 스크립트:
  - `eval/valuation_analysis_21_30_v1.jsonl` (30건)
  - `scripts/eval_valuation_analysis.py`

14) 시너지 10문항(31~40) 대응
- API: `POST /api/synergy-analysis`
- 질문 범위: 매출/비용 시너지, 인력 중복, 유통망/조달 통합, IT 통합비, PMI 기간, 브랜드/법무 리스크
- 생성 스크립트:
  - `scripts/build_synergy_cases.py` -> `data/raw/synergy_case_*.json`
- 평가셋/평가 스크립트:
  - `eval/synergy_analysis_31_40_v1.jsonl` (30건)
  - `scripts/eval_synergy_analysis.py`
- 자동화 연결:
  - `run_full_collection.sh`에 시너지 케이스 단계 포함 (`SYNERGY_CASE_ENABLED=1`)

15) 리스크/실사 10문항(41~50) 대응
- API: `POST /api/due-diligence-analysis`
- 질문 범위: 재무실사 포인트, 우발채무, 매출인식, 재고평가, 세무, 핵심인력, CoC 조항, 보안/개인정보, 공급망, PMI 실패요인
- 생성 스크립트:
  - `scripts/build_due_diligence_cases.py` -> `data/raw/due_diligence_case_*.json`
- 평가셋/평가 스크립트:
  - `eval/due_diligence_analysis_41_50_v1.jsonl` (30건)
  - `scripts/eval_due_diligence_analysis.py`
- 자동화 연결:
  - `run_full_collection.sh`에 실사 케이스 단계 포함 (`DUE_DILIGENCE_CASE_ENABLED=1`)
- 운영 연계:
  - 관리자 콘솔 작업 추가: 실사 케이스 생성 / 실사 10문항 평가

16) 전략 의사결정 10문항(51~60) 대응
- API: `POST /api/strategic-analysis`
- 질문 범위: 전략적/재무적 인수 판별, 포트폴리오 적합성, 3년 Exit, 기회비용, 경쟁사 인수 영향, 단계 인수, Earn-out, 합병/자회사, 현금/주식, 최적 딜 구조
- 생성 스크립트:
  - `scripts/build_strategic_cases.py` -> `data/raw/strategic_case_*.json`
- 평가셋/평가 스크립트:
  - `eval/strategic_analysis_51_60_v1.jsonl` (30건)
  - `scripts/eval_strategic_analysis.py`
- 자동화 연결:
  - `run_full_collection.sh`에 전략 케이스 단계 포함 (`STRATEGIC_CASE_ENABLED=1`)
- 운영 연계:
  - 관리자 콘솔 작업 추가: 전략 케이스 생성 / 전략 10문항 평가

17) 운영 콘솔 고도화 및 업체 검색 분리(최근)
- 상단 내비게이션 고정: `업체검색 / 전략 수립 / 운영 콘솔` 상시 노출
- 운영 콘솔 단순화 후 재구성:
  - 공시 데이터 대량 수집(실행/중지/진행률/로그 tail/완료 후 메모리 반영)
  - 공시 대량 수집 API:
    - `POST /api/admin/disclosure/start`
    - `GET /api/admin/disclosure/status`
    - `POST /api/admin/disclosure/stop`
- 업체 입력 기준 확립:
  - 대량 수집 제외 기능은 `업체명` 기준으로 실행

18) 소스 레이어 분리/등록 확장
- 분리 기준 정리(운영 정책):
  - `authoritative`: 공시(DART, Yahoo)
  - `internet`: 인터넷(뉴스/웹검색)
  - `ai`: AI 결과(OpenAI/Gemini)
  - `user_input`: 사용자 입력 텍스트
- 벡터 등록 확장:
  - AI 결과 등록: `POST /api/company-search/register-ai-results`
  - 인터넷 결과 등록: `POST /api/company-search/register-internet-results`
- 소스 레이어 인식 확장:
  - `app/services/rag_pipeline.py`의 `_source_layer_of_row`에 `internet`, `user_input` 처리 추가

19) 운영 콘솔 업체 검색 기능 확장
- AI 업체검색(운영 콘솔):
  - provider 선택(openai/gemini), 템플릿 선택, TXT 업로드 지원
  - AI 결과 DB 등록 버튼/로그 개선(시도/중단/취소/성공/실패/오류 표시)
- 인터넷 업체검색(운영 콘솔):
  - 뉴스 검색 + 일반 웹검색(옵션) 병합
  - 템플릿 선택, TXT 업로드 지원
  - 검색 결과 DB 등록 버튼 지원
  - API: `POST /api/admin/internet-company-search`

20) 템플릿 강제 프롬프트 전면 강화
- 강제 템플릿 질의 생성기 추가/강화: `app/routers/api.py::_build_template_forced_query`
- 아래 템플릿 모두 JSON 스키마/작성 규칙을 프롬프트에 명시:
  - `target_company_overview`
  - `industry_market_analysis`
  - `valuation_analysis`
  - `synergy_pair_analysis`
  - `due_diligence_risk_analysis`
  - `strategic_decision_analysis`

21) 업체명 명시 시 동작 규칙 강화
- 업체명 명시 시:
  - 후보군 유추 생략
  - 명시 업체 단일 기준으로 검색/생성
  - `selected_company`/`inferred_candidates`를 명시 업체 1개로 고정
- 업체명 미명시 시:
  - 기존 후보군 유추 로직 사용
- 업체명 고정 출력:
  - 모든 템플릿 결과에서 `업체명:`을 최상단에 출력
  - 공통 기본 응답에서 회사명/마켓 자동 보정 추가

22) 템플릿 품질 보강(정보 부족 축소)
- `valuation_analysis`:
  - 내부 재무 스냅샷 백필(`_backfill_answer_from_evidence`) 연계
  - 재무요약/멀티플/가치범위 fallback 보강
- `due_diligence_risk_analysis`:
  - 재무/법무·규제/운영/통합 4영역 컨텍스트 기반 fallback 보강
- `strategic_decision_analysis`:
  - 인수 필요성/재무 타당성/리스크 TOP3/최종의견 fallback 보강

끝.

23) 첫 페이지/운영 AI 저장 로직 정합화 (2026-02-19 00시대 작업)
- 문제 요약:
  - 첫 페이지 검색에서 `삼성전자` 기준으로 개요 템플릿만 AI 벡터 출처가 보이고,
    나머지 템플릿은 기존 데이터 위주로 보여 상호보완 의도와 불일치.
  - 운영 콘솔의 `AI 결과 DB 등록`은 템플릿 본문이 아닌 `유사업체 items`만 저장하고 있어,
    템플릿을 바꿔도 벡터에 실질적으로 같은 형태만 누적됨.
- 반영 내용 A (검색 보완):
  - 파일: `app/services/rag_pipeline.py`
  - 템플릿 공통 보조근거 병합 강화:
    - `_company_support_rows`에서 AI 레이어(`source_layer=ai`)를 alias 기준으로 직접 보강
    - 병합 상한을 `max(k*2, 12)`로 확대
    - `_merge_rows`를 교차 병합(기존/보조 번갈아)으로 변경해 AI 출처가 뒤로 밀려 사라지는 현상 완화
  - 템플릿별 `answer["sources"]`를 병합된 retrieved 기준으로 재계산
- 반영 내용 B (운영 AI 저장 수정: 핵심):
  - 파일: `app/schemas.py`
    - `RegisterAiResultsRequest`에 추가:
      - `template_id`, `template_name`, `company_name`, `answer_text`, `answer_json`
  - 파일: `app/services/rag_pipeline.py`
    - `register_ai_template_result(...)` 신규 추가
    - 저장 파일:
      - `data/raw/ai_template_result_<provider>_<template_id>_<timestamp>.json`
    - 벡터화 내용:
      - 회사명/템플릿ID/템플릿명/질의/AI Provider/템플릿 결과 본문/원본 JSON
    - 인덱스 메타:
      - `source_layer="ai"`, `source_type="ai_template_result"`
  - 파일: `app/routers/api.py`
    - `POST /api/company-search/register-ai-results` 확장:
      - 기존 `items` 저장 유지
      - 새 템플릿 본문 저장 동시 수행
      - 둘 중 하나라도 있으면 저장
  - 파일: `app/static/admin.js`
    - 운영 콘솔 AI 등록 요청에 템플릿 메타/본문/원본 JSON 동봉
- 운영 결과:
  - 이제 운영에서 템플릿을 바꿔 `AI 결과 DB 등록`을 반복하면
    템플릿별 본문 자체가 AI 벡터로 누적됨(기존 items-only 저장과 병행).
- Codex resume 인수인계 포인트:
  - 우선 확인 파일:
    - `app/services/rag_pipeline.py`
    - `app/routers/api.py`
    - `app/static/admin.js`
    - `app/schemas.py`
  - 확인 대상 데이터:
    - `data/raw/ai_template_result_*.json` 생성 여부
    - `data/index/chunks.jsonl` 내 `source_type=ai_template_result` 청크 존재 여부
  - 다음 검증 시나리오:
    - 운영 콘솔에서 같은 업체로 템플릿 2개 이상 검색 후 각각 DB 등록
    - 첫 페이지 검색 시 출처에 서로 다른 `ai_template_result_*`가 표시되는지 확인
